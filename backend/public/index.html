<!DOCTYPE html>
<html>
<head>
    <title>Job Applications Tracker</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .filter-button {
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .filter-button:hover {
            background-color: #0056b3;
        }
        .main-content {
            display: grid;
            grid-template-columns: 65% 35%;
            gap: 20px;
            margin-top: 20px;
        }
        
        .all-applications, .watchlist {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .watchlist {
            border-left: 4px solid gold;
            min-height: 200px;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .star-button {
            padding: 5px 10px;
            background: transparent;
            border: 2px solid #ffd700;
            color: #ffd700;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s;
            margin-left: 10px;
        }
        
        .star-button:hover {
            background: #ffd700;
            color: white;
        }
        
        .star-button.active {
            background: #ffd700;
            color: white;
        }
        
        .star-button {
            background: none;
            border: none;
            font-size: 1.2em;
            cursor: pointer;
            padding: 5px;
            margin-left: 10px;
            transition: transform 0.2s;
            opacity: 0.3;
        }

        .star-button:hover {
            transform: scale(1.2);
            opacity: 0.8;
        }

        .star-button.active {
            opacity: 1;
            color: gold;
            text-shadow: 0 0 2px rgba(0,0,0,0.3);
        }

        .star-button:disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }

        .watchlist {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-left: 4px solid gold;
        }

        .watchlist .section-header {
            color: #333;
            border-bottom: 2px solid gold;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        .watchlist .section-header h2 {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .watchlist .section-header h2::before {
            content: "‚≠ê";
            color: gold;
        }
        
        .application-count {
            color: #666;
            font-size: 0.9em;
        }
        
        .job {
            background: white;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        
        .job:hover {
            box-shadow: 0 3px 6px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }
        
        .job.email {
            border-left: 4px solid #28a745;
            margin: 10px 0;
        }
        
        .job h3 {
            margin: 0 0 10px 0;
            color: #333;
        }
        
        .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.9em;
            font-weight: bold;
            color: white;
        }

        .status.applied {
            background-color: #007bff;  /* Blue */
        }

        .status.interview {
            background-color: #28a745;  /* Green */
        }

        .status.rejected {
            background-color: #dc3545;  /* Red */
        }

        .status.accepted {
            background-color: #28a745;  /* Green */
        }
        
        .email-content {
            margin-top: 10px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 4px;
            font-size: 0.9em;
        }
        
        .platform-badge {
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.8em;
            color: white;
        }
        
        .platform-badge.workday { background: #0066cc; }
        .platform-badge.greenhouse { background: #00b388; }
        .platform-badge.lever { background: #f36; }
        .platform-badge.other { background: #666; }
        
        .job-info {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .info-row {
            flex: 1;
        }
        
        .email-details {
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
            font-size: 0.9em;
            color: #666;
        }
        
        .email-details p {
            margin: 5px 0;
        }
        
        .info-row p {
            margin: 8px 0;
            display: flex;
            align-items: baseline;
        }
        
        .info-row p strong {
            min-width: 80px;
            margin-right: 10px;
        }
        
        small {
            color: #666;
            margin-left: 10px;
            font-style: italic;
        }
        
        .no-applications {
            padding: 20px;
            text-align: center;
            color: #666;
            font-style: italic;
            background: #f9f9f9;
            border-radius: 4px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Job Applications Tracker</h1>
            <button id="toggleFilter" class="filter-button">Show All History</button>
        </div>
        
        <div class="main-content">
            <!-- Left side: All Applications -->
            <div class="all-applications">
                <div class="section-header">
                    <h2>All Applications</h2>
                    <span class="application-count" id="allCount">Loading...</span>
                </div>
                <div id="applicationsList"></div>
            </div>
            
            <!-- Right side: Watchlist -->
            <div class="watchlist">
                <div class="section-header">
                    <h2>‚≠ê Watchlist</h2>
                    <span class="application-count" id="watchlistCount">Loading...</span>
                </div>
                <div id="watchlistApplications"></div>
            </div>
        </div>
    </div>

    <script>
        let isInitialLoad = true;

        async function fetchJobs() {
            try {
                const response = await fetch(`http://localhost:5000/api/jobs?initialLoad=${isInitialLoad}`);
                const data = await response.json();
                
                console.log('üì¶ Raw data from server:', data);
                
                // Combine all jobs from both sources
                const allJobs = [...data.savedJobs, ...data.emailApplications];
                console.log('üìã All jobs:', allJobs);
                
                // Split into watchlist and regular applications
                const watchlist = allJobs.filter(job => job.isWatchlisted === true);
                const regular = allJobs.filter(job => !job.isWatchlisted);
                
                console.log('‚≠ê Watchlist jobs:', watchlist);
                console.log('üìù Regular jobs:', regular);
                
                // Update the counts
                document.getElementById('allCount').textContent = 
                    `${allJobs.length} applications`;
                document.getElementById('watchlistCount').textContent = 
                    `${watchlist.length} applications`;
                
                // Render the lists
                document.getElementById('applicationsList').innerHTML = 
                    renderApplications(allJobs) || '<div class="no-applications">No applications found</div>';
                document.getElementById('watchlistApplications').innerHTML = 
                    renderApplications(watchlist) || '<div class="no-applications">No watchlisted applications</div>';
                
                // Set initial load to false after first load
                isInitialLoad = false;
            } catch (error) {
                console.error('‚ùå Error:', error);
                document.getElementById('applicationsList').innerHTML = 
                    '<div class="error">Error loading applications. Please refresh the page.</div>';
                document.getElementById('watchlistApplications').innerHTML = 
                    '<div class="error">Error loading watchlist. Please refresh the page.</div>';
            }
        }

        function renderApplications(applications) {
            if (!applications || applications.length === 0) {
                return null; // Let the caller handle empty state
            }
            
            return applications.map(job => {
                const isWatchlisted = job.isWatchlisted === true;
                return `
                    <div class="job ${job.fromEmail ? 'email' : ''}" data-id="${job._id}">
                        <div class="job-info">
                            <div class="info-row">
                                <h3>
                                    ${job.company} - ${job.position}
                                    <button 
                                        onclick="toggleWatchlist('${job._id}')"
                                        class="star-button ${isWatchlisted ? 'active' : ''}"
                                        title="${isWatchlisted ? 'Remove from Watchlist' : 'Add to Watchlist'}"
                                    >‚≠ê</button>
                                </h3>
                                <p><strong>Status:</strong> 
                                    <span class="status ${job.status ? job.status.toLowerCase() : 'applied'}">
                                        ${job.status || 'Applied'}
                                    </span>
                                </p>
                                <p><strong>Applied:</strong> 
                                    ${new Date(job.dateApplied).toLocaleDateString()}
                                </p>
                                ${job.platform ? `
                                    <p><strong>Platform:</strong> 
                                        <span class="platform-badge ${job.platform.toLowerCase()}">
                                            ${job.platform}
                                        </span>
                                    </p>
                                ` : ''}
                            </div>
                        </div>
                        ${job.emailContent ? `
                            <div class="email-content">
                                ${job.emailContent}
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        async function toggleWatchlist(id) {
            try {
                // Find the star button for this job
                const jobElement = document.querySelector(`[data-id="${id}"]`);
                const starButton = jobElement.querySelector('.star-button');
                
                // Get current watchlist state from the button's active class
                const currentlyWatchlisted = starButton.classList.contains('active');
                console.log('üåü Toggling watchlist for job:', id, 'Current state:', currentlyWatchlisted);
                
                // Disable the button while processing
                starButton.disabled = true;
                
                // Make the API call
                const response = await fetch(`http://localhost:5000/api/jobs/${id}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        isWatchlisted: !currentlyWatchlisted // Toggle the current state
                    })
                });

                const data = await response.json();
                
                if (response.ok) {
                    console.log('‚úÖ Successfully updated watchlist status:', data);
                    
                    // Update the star button's appearance
                    const isWatchlisted = data.job.isWatchlisted;
                    starButton.classList.toggle('active', isWatchlisted);
                    starButton.title = isWatchlisted ? 'Remove from Watchlist' : 'Add to Watchlist';
                    
                    // Re-fetch all jobs to update both lists
                    await fetchJobs();
                } else {
                    console.error('‚ùå Server error:', data);
                    alert('Failed to update watchlist status. Please try again.');
                }
            } catch (error) {
                console.error('‚ùå Error toggling watchlist:', error);
                alert('An error occurred. Please try again.');
            } finally {
                // Re-enable the button
                const jobElement = document.querySelector(`[data-id="${id}"]`);
                if (jobElement) {
                    const starButton = jobElement.querySelector('.star-button');
                    if (starButton) {
                        starButton.disabled = false;
                    }
                }
            }
        }

        // Initial load
        fetchJobs();

        // Toggle filter button
        document.getElementById('toggleFilter').addEventListener('click', () => {
            isInitialLoad = !isInitialLoad;
            const button = document.getElementById('toggleFilter');
            button.textContent = isInitialLoad ? 'Show All History' : 'Show Recent';
            fetchJobs();
        });
    </script>
</body>
</html>
